image: golang:1.23

definitions:
  services:
    postgres16:
      image: postgres:16
      environment:
        POSTGRES_DB: simple_bank
        POSTGRES_USER: root
        POSTGRES_PASSWORD: secret
        POSTGRES_HOST_AUTH_METHOD: trust
      ports:
        - "5432"
      healthcheck:
        test: ["CMD-SHELL", "pg_isready -U root"]
        interval: 10s
        timeout: 10s
        retries: 10
  caches:
    gomodules: vendor

  steps:
    - step: &test-step
        name: Run Unit Tests
        caches:
          - gomodules
        services:
          - postgres16
        script:
          - echo "Running migrations"
          - echo "Installing golang-migrate"
          - curl -L https://github.com/golang-migrate/migrate/releases/download/v4.17.1/migrate.linux-amd64.tar.gz | tar xvz
          - mv migrate /usr/bin/migrate
          - export PATH=$PATH:/usr/bin/migrate
          - migrate -version
          - if [ ! -d "vendor" ] || [ -z "$(ls -A vendor)" ]; then go mod vendor; fi
          - echo "Build project"
          - go build ./...
          - echo "Running migrations"
          - make migrateup
          - echo "Running tests"
          - make test

pipelines:
  default:
    - step: *test-step

  branches:
    main:
      - step: *test-step

    develop:
      - step: *test-step
  
  pull-requests:
    "**":
      - step: *test-step
