image: atlassian/default-image:4
# image: golang:1.23

definitions:
  services:
    postgres16:
      image: postgres
      variables:
        POSTGRES_DB: simple_bank
        POSTGRES_USER: root
        POSTGRES_PASSWORD: secret

pipelines:
  default:

    - step:
        name: Install golang
        script:
          - curl -L https://go.dev/dl/go1.23.1.linux-arm64.tar.gz | tar xvz
          - rm -rf /usr/local/go && tar -C /usr/local -xzf go1.23.1.linux-amd64.tar.gz
          - export PATH=$PATH:/usr/bin/migrate
          - go version
          - which go

    - step:
        name: Install golang-migrate
        script:
          - curl -L https://github.com/golang-migrate/migrate/releases/download/v4.17.1/migrate.linux-amd64.tar.gz | tar xvz
          - mv migrate /usr/bin/migrate
          - which migrate
          - export PATH=$PATH:/usr/bin/migrate

    - step:    
        name: Run migrations
        script:
          - make migrateup

    - step:    
        name: Run tests
        script:
          - make test
